name: ENC-RUNNER

on:
  push:
    branches:
      - main

jobs:
  download:
    runs-on: ubuntu-latest
    container:
      image: docker.io/amandaa00/git-atc:test-para
    outputs:
      segments: ${{ steps.get-segments.outputs.segments }}
    steps:
      - name: Install jq
        run: |
          apt-get update
          apt-get install -y jq
      - name: Cache files for download
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /app
          key: ${{ github.sha }}-download
      - name: Run download script
        run: |
          cd /app
          python3 download.py ZnVjawZXlKUFYwNUZVaUk2SWt0cGJtYzVPRGd4SWl3aVVrVlFUeUk2SW5WeVltRnVMVzlqZEc4dGMzVmpZMjkwWVhOb0lpd2lWRWRmUVZCSlgwbEVJam9pTVRZMU5EWXlOekFpTENKVVIxOUJVRWxmU0VGVFNDSTZJakZsTVdWbU1XSmlZalpsT0dNMlltTTVNREF5TURkallUVmhNVEZqWmpaaUlpd2lWRWRmUWs5VVgxUlBTMFZPSWpvaU5USTRNamszTkRjMk5UcEJRVWRJVG1wQ1EzRlNlWFo0WjFWVE9XOTVORWhVUjBOME5VSkRhbk5rTFVwaWN5SXNJa1pKVEVVaU9qRTJOekFzSWtaSlRFVmZUa0ZOUlNJNklsc2dRa3hESUYwZ0lGTXpSVGtnV1dWc2JHOTNjM1J2Ym1VdWJXdDJJaXdpU1VRaU9pSlpaV3hmTTJJM1BUSWlMQ0pEVFVRaU9pSmFiVnAwWTBkV2JrbERNWEJKU0hSd1ltdzViV0ZYZUd4bVUwRjBXbTFzYzJSSFZubFlNazUyWWxoQ2MxcFlaMmRKYlZKNVdWaGtNRnBZYURCUVYxcDJZbTVTYldGWGVHeFFWMmQxWkVoU2JVOXVVbXhsU0ZFNVNubENWVko1UVhSSlJVSnBZa2hXYkZreVJuSmFWamwxV2xoU00ySXpTbkpKUTJNMldtMDVkV1JIVG5aaVJ6bDVVRmhrYjJGWVVteFBiVnAyWW01U2VtRlljR3hRVkVrd1QyNW5PVTFVUVRabFZEQjRUVU5KWjB4WE1XaGpRMEYzU1VNeGRGcFlVbWhhUjBZd1dWUndlazl0Uldka1Iyd3dZa2RWT1Vsc1VraFBhVUpCV1cxNE1WcFhUbWhoTWxabVltMVdNR1F5T1hsaGVVbG5URmN4YkdSSFJtdFpXRkpvVDI1Tk5tTjVRakJoV0ZKeldsUXdhVlpGWXpaSlJVSnBZa2hXYkZreVJuSmFWamwxV2xoU00ySXpTbkpKUTBsblRGY3hiR1JIUm10WldGSm9TVWhTY0dSSGVHeFFVMHBWVW5wdloxRkhTbk5rVjFacVdWZDBiRmd5Tld4a1NHUjJZMjF6YVVsRE1XcFBibGxuWWtkc2FXTXpXakJaV0ZsNFNVTXhkMk50Vm5wYVdGRm5UbWxCZEZwNVFYbE9SRUZuVEZoTlowMVVTVFJOU0djelRXcEJaMHhZUW5CbFJqbHRZbGhSWjJWWVZqSk9SRWwzWTBOQmRHTXpXakJaV0ZsNFRGaENhR050Um5SamVVSXdaRmMxYkZCVVJUWmFiV3h6WWxNeGJtTnRSbkJpYWpCM1NVTXhhbU50V1dkT1JHTm5URmQ0ZGxveWVHeGtiVlp6U1VkV2VXTnRPWGxKUXpGcVQyMUZaMkpIYkdsaU0wSXhZM2xCZEZsWFRXZE5hVUYwV1ZkSlowNUVRbkpKUXpGcVQyNU5aMWt5T1hkbFUwSTNZak5DWmxwdGJITmFXREJuVEZoclBTSjk=
          
      - name: Get segments
        id: get-segments
        run: |
          SEGMENTS=$(jq -c '.OUTPUT_FILES | keys' /app/data.json)
          echo "segments=$SEGMENTS" >> $GITHUB_OUTPUT

  encode:
    needs: download
    runs-on: ubuntu-latest
    strategy:
      matrix:
        segment: ${{ fromJson(needs.download.outputs.segments) }}
    container:
      image: docker.io/amandaa00/git-atc:test-para
    steps:
      - name: Install jq
        run: |
          apt-get update
          apt-get install -y jq
      - name: Restore download cache (for required files)
        id: restore-download-cache
        uses: actions/cache@v3
        with:
          path: /app
          key: ${{ github.sha }}-download
      - name: Restore shared cache (for encoded files)
        id: restore-shared-cache
        uses: actions/cache@v3
        with:
          path: /app
          key: ${{ github.sha }}-shared
      - name: Encode segment
        run: |
          cd /app
          python3 encode.py ${{ matrix.segment }}
      - name: Save encoded files to shared cache
        id: save-shared-cache
        uses: actions/cache@v3
        with:
          path: /app
          key: ${{ github.sha }}-shared

  upload:
    needs: [download, encode]
    runs-on: ubuntu-latest
    container:
      image: docker.io/amandaa00/git-atc:test-para
    steps:
      - name: Restore shared cache (for encoded files)
        uses: actions/cache@v3
        with:
          path: /app
          key: ${{ github.sha }}-shared
      - name: Merge and upload files
        run: |
          cd /app
          python3 upload.py
